<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inforium Communication Canvas — Prototype (Projects + Templates)</title>

  <style>
    :root{
      --bg: #eef3fb;
      --panel: #ffffff;
      --panel2: #f6f8fd;
      --line: #d7e1f0;
      --text: #1b2a3a;
      --muted: #6c7c93;
      --shadow: 0 10px 26px rgba(19, 33, 68, .10);

      --blue: #2f6ea5;
      --blueDark: #245a86;
      --blueSoft: rgba(47,110,165,.10);

      --red: #d64a4a;
      --green: #2a9d6f;

      --radius: 12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: var(--bg);
      overflow:hidden;
    }

    header.appbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      background: var(--panel);
      border-bottom:1px solid var(--line);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; }
    .logoMark{
      width:28px; height:28px; border-radius:8px;
      background: linear-gradient(135deg, var(--blue), #4aa0d6);
      box-shadow: 0 6px 14px rgba(47,110,165,.25);
    }
    .subtitle{ color:var(--muted); font-weight:500; font-size:12px; margin-top:2px; }

    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button, select, .pill{
      font-family:var(--font);
      border:1px solid var(--line);
      background: var(--panel);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      transition:.12s ease;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(19,33,68,.08); }
    button:active{ transform: translateY(0px); box-shadow:none; }

    button.primary{
      border-color: rgba(47,110,165,.25);
      background: var(--blueSoft);
      color: var(--blueDark);
      font-weight:700;
    }
    button.primarySolid{
      border-color: rgba(47,110,165,.40);
      background: var(--blue);
      color: #fff;
      font-weight:800;
    }
    button.danger{
      border-color: rgba(214,74,74,.35);
      background: rgba(214,74,74,.08);
      color: #9a2f2f;
      font-weight:700;
    }
    .pill{
      cursor:default;
      background: var(--panel2);
      color: var(--muted);
      font-weight:600;
    }

    main.app{
      height: calc(100% - 56px);
      display:grid;
      /* Resizable columns: Left (projects+library) | Center (lens+canvas) | Right (inspector) */
      grid-template-columns: var(--leftWidth, 560px) 10px 1fr 10px var(--rightWidth, 360px);
      gap:12px;
      padding:12px;
    }

    .appResizer{
      border-radius: 10px;
      background: rgba(27,42,58,.06);
      border: 1px solid rgba(27,42,58,.10);
      cursor: col-resize;
      align-self: stretch;
      min-height: 180px;
    }
    .appResizer:hover{ background: rgba(47,110,165,.10); border-color: rgba(47,110,165,.22); }
    .panel{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    /* LEFT: Projects + Palette */
    .leftTop{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: var(--panel);
    }
    .leftTop h2{ margin:0; font-size:13px; }
    .leftTop .subtitle{ margin-top:6px; }

    .projectBox{
      background:#f0f5ff;
      border-top:1px solid rgba(255,255,255,.65);
      border-bottom:1px solid var(--line);
      padding:10px;
      overflow:auto;
      max-height: 230px;
    }
    .projectSearch{
      display:flex; gap:8px; margin-bottom:10px;
    }
    .projectSearch input{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
      outline:none;
    }
    .projectList{ display:grid; gap:8px; }
    .projectItem{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      cursor:pointer;
      transition:.12s ease;
    }
    .projectItem:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(19,33,68,.08);
      border-color: rgba(47,110,165,.25);
    }
    .projectItem.active{
      border-color: rgba(47,110,165,.55);
      box-shadow: 0 0 0 4px rgba(47,110,165,.10) inset;
    }
    .projectTitle{ font-weight:900; font-size:13px; display:flex; justify-content:space-between; gap:10px; }
    .projectMeta{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }
    .badge{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(47,110,165,.25);
      background: rgba(47,110,165,.08);
      color: var(--blueDark);
      white-space:nowrap;
      height: fit-content;
    }

    .search{
      display:flex; gap:8px;
      padding:10px;
      border-bottom:1px solid var(--line);
      background: var(--panel);
    }
    .search input{
      width:100%;
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
      outline:none;
    }

    .palette{
      padding:10px;
      overflow:auto;
      background: #f0f5ff;
    }

    /* 3 columns: Content / Channels / Actions */
    .paletteCols{
      display:grid;
      grid-template-columns: var(--palW1, 1fr) 8px var(--palW2, 1fr) 8px var(--palW3, 1fr);
      gap:10px;
      align-items:start;
      min-width: 0;
    }
    .palResizer{
      border-radius: 10px;
      background: rgba(27,42,58,.06);
      border: 1px solid rgba(27,42,58,.10);
      cursor: col-resize;
      align-self: stretch;
      min-height: 240px;
    }
    .palResizer:hover{ background: rgba(47,110,165,.10); border-color: rgba(47,110,165,.22); }

    .paletteColWrap{
      border-radius: 14px;
      border: 1px solid var(--line);
      padding:10px;
    }
    .paletteColWrap.content{ background: rgba(47,110,165,.10); border-color: rgba(47,110,165,.22); }
    .paletteColWrap.channels{ background: rgba(42,157,111,.10); border-color: rgba(42,157,111,.22); }
    .paletteColWrap.actions{ background: rgba(214,74,74,.10); border-color: rgba(214,74,74,.18); }

    .paletteColTitle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.10em;
      padding:2px 2px 10px;
    }
    .paletteDot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(27,42,58,.18);
      background: rgba(108,124,147,.18);
    }
    .paletteColWrap.content .paletteDot{ background: rgba(47,110,165,.28); border-color: rgba(47,110,165,.28); }
    .paletteColWrap.channels .paletteDot{ background: rgba(42,157,111,.28); border-color: rgba(42,157,111,.28); }
    .paletteColWrap.actions .paletteDot{ background: rgba(214,74,74,.26); border-color: rgba(214,74,74,.26); }

    .paletteCol{ display:grid; grid-template-columns:1fr; gap:10px; }

    /* Slight tint for library cards per column */
    .paletteColWrap.content .item{ background: rgba(255,255,255,.65); border-color: rgba(47,110,165,.22); }
    .paletteColWrap.channels .item{ background: rgba(255,255,255,.65); border-color: rgba(42,157,111,.22); }
    .paletteColWrap.actions .item{ background: rgba(255,255,255,.65); border-color: rgba(214,74,74,.20); }

    .paletteColTitle{
      font-size:11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.10em;
      padding:6px 2px;
    }
    .paletteCol{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .item{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:10px;
      cursor:grab;
      user-select:none;
    }
    .item:active{ cursor:grabbing; }
    .item .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      font-weight:800;
      font-size:13px;
    }
    .tag{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--panel2);
      color: var(--muted);
      white-space:nowrap;
    }
    .item .desc{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* CENTER */
    .canvasTop{
      padding:10px;
      border-bottom:1px solid var(--line);
      background: var(--panel);
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
    }
    .canvas{
      flex:1;
      overflow:auto;
      padding:12px;
      background: var(--bg);
    }
    .phase{
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.65);
      padding:10px;
      margin-bottom:12px;
    }
    .phaseTitle{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .phaseTitle h3{ margin:0; font-size:13px; }
    .phaseTitle .meta{ color:var(--muted); font-size:12px; }

    .lanes{
      display:grid;
      grid-template-columns: 200px 1fr;
      gap:10px;
      align-items:stretch;
      margin-bottom:10px;
    }
    .laneLabel{
      background: #f3f6ff;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      min-height: 120px;
    }
    .laneLabel b{ color: var(--text); }

    .laneDrop{
      position:relative;
      background: #fff;
      border:1px dashed rgba(47,110,165,.35);
      border-radius: 12px;
      min-height:140px;
      overflow:auto; /* keep nodes fully visible; scroll if needed */
    }
    .laneDrop.dragover{
      border-color: rgba(47,110,165,.75);
      box-shadow: 0 0 0 4px rgba(47,110,165,.10) inset;
    }
    .laneHint{
      position:absolute;
      top:10px; left:10px;
      font-size:12px; color:rgba(108,124,147,.9);
      pointer-events:none;
    }

    .node{
      position:absolute;
      /* Responsive width so cards always fit inside swimlanes */
      width: min(340px, calc(100% - 16px));
      max-width: calc(100% - 16px);
      min-width: 220px;
      background: #fff;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px 8px;
      box-shadow: 0 10px 18px rgba(19,33,68,.08);
      cursor:move;
    }
    .node.selected{
      outline: 2px solid rgba(47,110,165,.55);
      box-shadow: 0 0 0 6px rgba(47,110,165,.10), 0 10px 18px rgba(19,33,68,.08);
    }
    
    /* Node coloring by category (Content / Kanalen / Acties) */
    .node.cat-content{ background: rgba(47,110,165,.10); border-color: rgba(47,110,165,.28); }
    .node.cat-channel{ background: rgba(42,157,111,.10); border-color: rgba(42,157,111,.28); }
    .node.cat-action{  background: rgba(214,74,74,.10); border-color: rgba(214,74,74,.24); }

    /* Delete button on node */
    .nodeDel{
      /* inline delete button (no overlap with label) */
      position:static;
      width:22px; height:22px;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight:900;
      line-height:1;
      display:flex; align-items:center; justify-content:center;
      color:#314055;
      padding:0;
    }
    .nodeDel:hover{ background:#fff; }
    .hdrRight{ display:flex; gap:6px; align-items:center; }
    .hdr .title{ flex:1; min-width:0; }

    .node .hdr{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      font-size:13px;
      font-weight:900;
    }
    .node .kind{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(47,110,165,.25);
      background: rgba(47,110,165,.08);
      color: var(--blueDark);
      white-space:nowrap;
    }
    .node .body{
      margin-top:6px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .chips{
      margin-top:8px;
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .chip{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--panel2);
      color: var(--muted);
    }

    /* RIGHT */
    .panelHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: var(--panel);
    }
    .panelHeader h2{ margin:0; font-size:13px; }
    .panelHeader .hint{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }

    .inspector{
      padding:10px;
      overflow:auto;
      background: #f0f5ff;
    }
    .field{ margin:10px 0; }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    .field input, .field textarea{
      width:100%;
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      padding:10px;
      border-radius:10px;
      outline:none;
    }
    .field textarea{ min-height:92px; resize:vertical; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .small{ font-size:12px; color:var(--muted); line-height:1.45; }

    .footerHelp{
      padding:10px 12px;
      border-top:1px solid var(--line);
      background: var(--panel);
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(27,42,58,.25);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(940px, 100%);
      background: #fff;
      border:1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: var(--panel);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal header h3{ margin:0; font-size:14px; }
    .modalHint{
      padding:0 14px 10px;
      color:var(--muted);
      font-size:12px;
      border-bottom:1px solid var(--line);
      background: var(--panel);
    }
    .modalBody{
      padding:12px 14px;
      max-height: 70vh;
      overflow:auto;
      background: var(--bg);
    }
    pre{
      white-space:pre-wrap;
      word-break:break-word;
      background: #fff;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:12px;
      margin:0;
      color: #1b2a3a;
      font-size:12px;
      line-height:1.45;
    }

    /* Print */
    @media print{
      header.appbar, main.app{ display:none !important; }
      #printSheet{ display:block !important; }
    }
    #printSheet{ display:none; padding:18px; }
    #printSheet h1{ margin:0 0 10px; font-size:18px; }
    #printSheet .meta{ color:#445; font-size:12px; margin-bottom:14px; }
    #printSheet .box{
      border:1px solid #ccd;
      border-radius:12px;
      padding:12px;
      background:#fff;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      line-height:1.45;
    }

    @media (max-width: 1280px){
      main.app{ grid-template-columns: 380px 1fr; }
      .panel.right{ display:none; }
    }
    @media (max-width: 980px){
      main.app{ grid-template-columns: 1fr; }
      .panel.right{ display:none; }
      body{ overflow:auto; }
    }
  </style>
</head>

<body>
  <header class="appbar">
    <div class="brand">
      <span class="logoMark" aria-hidden="true"></span>
      <div>
        <div>Inforium Communication Canvas</div>
        <div class="subtitle">Prototype — Projects + Templates + doelgroep flows</div>
      </div>
    </div>

    <div class="toolbar">
      <span class="pill" id="statusPill">Niet opgeslagen</span>
      <span class="pill" id="countPill">0 nodes</span>

      <!-- Templates -->
      <select id="templateSelect" title="Kies sjabloon"></select>
      <button class="primary" id="btnLoadTemplate">Laad sjabloon</button>
      <button class="primary" id="btnSaveTemplate">Opslaan als sjabloon</button>
      <button id="btnManageTemplates">Export/Import sjablonen</button>

      <button class="primary" id="btnSave">Opslaan</button>
      <button id="btnLoad">Laden</button>

      <button class="primary" id="btnExportTxt">Export TXT</button>
      <button class="primary" id="btnExportWord">Export Word</button>
      <button class="primarySolid" id="btnExportPdf">Export PDF</button>

      <button id="btnExportJson">Export JSON</button>
      <button id="btnReport">Rapport preview</button>
      <button class="danger" id="btnReset">Reset</button>
    </div>
  </header>

  <main class="app">
    <!-- LEFT -->
    <section class="panel left" aria-label="Project selector en blokkenbibliotheek">
      <div class="leftTop">
        <h2>Project / Zorgpad (selector)</h2>
        <div class="subtitle">Klik op een project om een sjabloon te laden</div>
      </div>

      <div class="projectBox">
        <div class="projectSearch">
          <input id="projectSearch" type="search" placeholder="Zoek project… (bv. MDL, KNO, operatie)" />
        </div>
        <div class="projectList" id="projectList"></div>
        <div class="subtitle" style="margin-top:10px;">
          Tip: deze selector is expres simpel, zodat dev/low-code dit kan mappen naar een “Projects” tabel.
        </div>
      </div>

      <div class="search">
        <input id="search" type="search" placeholder="Zoek blokken… (bv. Thuisarts, Indiveo, portaal, QR)" aria-label="Zoeken in blokkenbibliotheek">
      </div>

      <div class="palette" id="palette">
        <div class="paletteCols" id="paletteCols">
          <div class="paletteColWrap content">
            <div class="paletteColTitle"><span class="paletteDot"></span>Content</div>
            <div id="paletteContent" class="paletteCol"></div>
          </div>

          <div class="palResizer" id="palResizer1" title="Sleep om kolombreedte aan te passen"></div>

          <div class="paletteColWrap channels">
            <div class="paletteColTitle"><span class="paletteDot"></span>Kanalen</div>
            <div id="paletteChannels" class="paletteCol"></div>
          </div>

          <div class="palResizer" id="palResizer2" title="Sleep om kolombreedte aan te passen"></div>

          <div class="paletteColWrap actions">
            <div class="paletteColTitle"><span class="paletteDot"></span>Acties</div>
            <div id="paletteActions" class="paletteCol"></div>
          </div>
        </div>
      </div>

      </div>

      <div class="footerHelp">
        <b>Wat doet de Project selector?</b><br/>
        • Laadt meteen een “startcanvas” voor een gekozen use case (bijv. MDL scopie, KNO poli, operatie).<br/>
        • Later koppel je dit aan echte projecten, afdelingen, patiëntgroepen en distributiekanalen.
      </div>
    </section>

    <div class="appResizer" id="resizerLeft" title="Sleep om de linker kolom te verbreden/versmallen"></div>

    <!-- CENTER -->
    <section class="panel center" aria-label="Canvas">
      <div class="canvasTop">
        <b>Lens:</b>
        <select id="lens" aria-label="Selecteer doelgroep lens">
          <option value="all">Alles</option>
          <option value="normaal">Normaal</option>
          <option value="laaggeletterd">Laaggeletterd</option>
          <option value="anderstalig">Anderstalig</option>
          <option value="digitaal_savvy">Digitaal savvy</option>
        </select>

        <span class="pill">Lane = fase × doelgroep</span>
      </div>

      <div class="canvas" id="canvas" aria-label="Canvas editor"></div>

      <div class="footerHelp">
        <b>Output:</b> Rapport (TXT/Word/PDF) + JSON export voor dev/low-code.
      </div>
    </section>

    <div class="appResizer" id="resizerRight" title="Sleep om de rechter kolom te verbreden/versmallen"></div>

    <!-- RIGHT -->
    <section class="panel right" aria-label="Inspector">
      <div class="panelHeader">
        <h2>Inspector</h2>
        <div class="hint">Selecteer een node om metadata aan te passen (taal, timing, toegankelijkheid).</div>
      </div>

      <div class="inspector" id="inspector">
        <div class="small" id="noSelection">
          Geen node geselecteerd.<br/><br/>
          <b>Low-code mapping</b><br/>
          • Nodes = tabel/collection<br/>
          • Filter op phaseId + audienceId<br/>
          • Inspector = edit-form van record<br/>
          • Export = JSON of rapport
        </div>

        <div id="inspectorForm" style="display:none;">
          <div class="field">
            <label>Type</label>
            <input id="fKind" disabled />
          </div>

          <div class="field">
            <label>Titel</label>
            <input id="fTitle" />
          </div>

          <div class="field row2">
            <div>
              <label>Taalniveau</label>
              <input id="fLevel" placeholder="A2 / B1 / B2" />
            </div>
            <div>
              <label>Talen</label>
              <input id="fLang" placeholder="NL, EN, TR…" />
            </div>
          </div>

          <div class="field row2">
            <div>
              <label>Timing</label>
              <input id="fTiming" placeholder="T-7 / T-2 / T0 / T+1" />
            </div>
            <div>
              <label>Owner</label>
              <input id="fOwner" placeholder="poli-assistentie / arts / portaal" />
            </div>
          </div>

          <div class="field">
            <label>Omschrijving / inhoud</label>
            <textarea id="fBody" placeholder="Korte uitleg, tekst of instructie…"></textarea>
          </div>

          <div class="field row2">
            <div>
              <label>Alt-tekst (blind/slechtziend)</label>
              <input id="fAlt" placeholder="Alt-tekst / audio variant" />
            </div>
            <div>
              <label>Transcript (slechthorend)</label>
              <input id="fTranscript" placeholder="ja / link / nee" />
            </div>
          </div>

          <div class="field row2">
            <button class="primary" id="btnApply">Toepassen</button>
            <button class="danger" id="btnDelete">Verwijderen</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">Output</h3>
        <button id="btnCloseModal">Sluiten</button>
      </header>
      <div class="modalHint" id="modalHint">Preview</div>
      <div class="modalBody"><pre id="modalPre"></pre></div>
    </div>
  </div>

  <!-- Print sheet -->
  <div id="printSheet">
    <h1>Inforium Communication Canvas — Rapport</h1>
    <div class="meta" id="printMeta"></div>
    <div class="box" id="printBox"></div>
  </div>

  <!-- hidden file input for template import -->
  <input type="file" id="templateImportFile" accept=".json,application/json" style="display:none;" />

<script>
/* =============================================================================
   Bronnen (MDN):
   - localStorage + Web Storage API: :contentReference[oaicite:4]{index=4}
   - Drag & Drop + DataTransfer.setData: :contentReference[oaicite:5]{index=5}
   - Blob downloads + createObjectURL/revokeObjectURL: :contentReference[oaicite:6]{index=6}
   - Print/PDF via window.print + @media print: :contentReference[oaicite:7]{index=7}
   ============================================================================= */

/* =============================================================================
   CONFIG
   ============================================================================= */
const PHASES = [
  { id: "vooraf",   title: "Vooraf (T-14 → T-1)" },
  { id: "dagzelf",  title: "Dag van afspraak (T0)" },
  { id: "nazorg",   title: "Nazorg (T0 → T+7)" },
  { id: "followup", title: "Follow-up (T+7 →)" },
];

const AUDIENCES = [
  { id: "normaal",        label: "Normaal", hint: "Standaard info, normale taal." },
  { id: "laaggeletterd",  label: "Laaggeletterd", hint: "A2/B1 + pictogrammen + kort." },
  { id: "anderstalig",    label: "Anderstalig", hint: "Meertalig + visueel + simpel." },
  { id: "digitaal_savvy", label: "Digitaal savvy", hint: "Self-service + reminders + deeplinks." },
];

function mkItem(kind, title, desc, tag){ return { kind, title, desc, tag }; }

/* Content / Channels / Actions are driven by tag mapping */
const PALETTE_ITEMS = [
  /* CONTENT: Inforium + externe content */
  mkItem("inforium_item", "Inforium item", "Betrouwbare patiëntinfo (contextueel).", "Content"),
  mkItem("inforium_set", "Inforium bundel", "Set van meerdere Inforiums (zorgpadfase).", "Content"),
  mkItem("studio_video", "Inforium Studio video", "Hybride AI-video met varianten.", "Content"),
  mkItem("fragment", "Videofragment", "Herbruikbaar fragment (route, voorbereiding).", "Content"),

  mkItem("indiveo", "Indiveo content", "Externe video/animatie content (placeholder).", "Content"),
  mkItem("thuisarts", "Thuisarts.nl pagina", "Betrouwbare NL patiënteninformatie (link).", "Content"),
  mkItem("folder", "Ziekenhuis folder (PDF)", "Eigen folder of patiëntbrief als PDF.", "Content"),
  mkItem("webpage", "Ziekenhuis webpagina", "Afdelingspagina met uitleg + route.", "Content"),

  /* CHANNELS */
  mkItem("mondeling", "Mondeling / fysiek", "Balie, arts, verpleegkundige, telefoon.", "Kanaal"),
  mkItem("papier", "Folder / papier", "Print + QR, meegeven of opsturen.", "Kanaal"),
  mkItem("website", "Website", "Pagina met basisinfo + links.", "Kanaal"),
  mkItem("portaal", "Portaal / PGO", "EPD-portaal of PGO berichten.", "Kanaal"),
  mkItem("beterdichtbij", "BeterDichtbij", "Bericht + deeplink + reminder.", "Kanaal"),
  mkItem("luscii", "Luscii", "Monitoring / taken / voorlichting.", "Kanaal"),
  mkItem("journey", "Patient Journey app", "Zorgpad-app met stappen/notificaties.", "Kanaal"),
  mkItem("medify", "Medify / complex", "Complexe app (placeholder, integratie).", "Kanaal"),
  mkItem("vragenlijst", "Vragenlijst / intake", "Formulier, triage, voorbereiding.", "Kanaal"),

  /* ACTIONS */
  mkItem("send_link", "Stuur link", "E-mail/SMS/app met deeplink.", "Actie"),
  mkItem("send_qr", "Stuur QR", "QR-code naar mobiel/print.", "Actie"),
  mkItem("reminder", "Reminder", "T-2 of T-1 reminder met 1 klik actie.", "Actie"),
  mkItem("check_begrip", "Check begrip", "Teach-back / 1–3 vragen.", "Actie"),
  mkItem("feedback", "Feedback", "Korte evaluatie na afloop.", "Actie"),
  mkItem("fallback", "Fallback pad", "Als kanaal faalt: alternatief kanaal.", "Actie"),
];

/* =============================================================================
   TEMPLATES (built-in) + user storage
   ============================================================================= */
const STORAGE_KEY = "inforium_canvas_ui_v5";
const TEMPLATES_USER_KEY = "inforium_canvas_templates_user_v1";

/* Built-in templates (8) */
const TEMPLATES_BUILTIN = [
  templatePoliNormaal(),
  templatePoliLaaggeletterd(),
  templatePoliAnderstalig(),
  templatePoliDigitaal(),
  templateVerrichtingNormaal(),
  templateVerrichtingLaaggeletterd(),
  templateVerrichtingAnderstalig(),
  templateVerrichtingDigitaal(),
];

/* Projects (Option B): simple selector -> loads a template */
const PROJECTS = [
  {
    id: "poli_kno_normaal",
    title: "KNO Polikliniekbezoek",
    badge: "Poli",
    desc: "Startflow voor afspraak → route → consult → nazorg (normaal).",
    templateScopeId: "built-in:poli_normaal",
    lens: "all"
  },
  {
    id: "poli_mdl_lg",
    title: "MDL Polibezoek (laaggeletterd)",
    badge: "Poli",
    desc: "A2/B1, video+QR, begrip-checks, fallback bellen.",
    templateScopeId: "built-in:poli_lg",
    lens: "laaggeletterd"
  },
  {
    id: "poli_anders",
    title: "Polibezoek (anderstalig)",
    badge: "Poli",
    desc: "Meertalig + visueel, reminders in taal, kanaalalternatieven.",
    templateScopeId: "built-in:poli_anders",
    lens: "anderstalig"
  },
  {
    id: "poli_digitaal",
    title: "Polibezoek (digitaal savvy)",
    badge: "Poli",
    desc: "Self-service: portaal/app, intake digitaal, reminders, check-in.",
    templateScopeId: "built-in:poli_digitaal",
    lens: "digitaal_savvy"
  },
  {
    id: "op_normaal",
    title: "Verrichting/Operatie (normaal)",
    badge: "Operatie",
    desc: "Voorbereiding (nuchter/medicatie), dag zelf, nazorg + alarmsignalen.",
    templateScopeId: "built-in:verr_normaal",
    lens: "all"
  },
  {
    id: "op_lg",
    title: "Verrichting/Operatie (laaggeletterd)",
    badge: "Operatie",
    desc: "Heel kort + 1-pager + video, extra begrip-checks, duidelijke fallback.",
    templateScopeId: "built-in:verr_lg",
    lens: "laaggeletterd"
  },
  {
    id: "op_anders",
    title: "Verrichting/Operatie (anderstalig)",
    badge: "Operatie",
    desc: "Meertalig, ondertitels, reminders nuchter, evt. tolk ondersteuning.",
    templateScopeId: "built-in:verr_anders",
    lens: "anderstalig"
  },
  {
    id: "op_digitaal",
    title: "Verrichting/Operatie (digitaal savvy)",
    badge: "Operatie",
    desc: "Portaal/app als single source, pre-check digitaal, uitslagflow.",
    templateScopeId: "built-in:verr_digitaal",
    lens: "digitaal_savvy"
  },
];

/* =============================================================================
   STATE
   ============================================================================= */
let state = { nodes: [], selectedNodeId: null, dirty: false };
let selectedProjectId = null;

/* =============================================================================
   DOM refs
   ============================================================================= */
const els = {
  canvas: document.getElementById("canvas"),
  search: document.getElementById("search"),
  lens: document.getElementById("lens"),
  countPill: document.getElementById("countPill"),
  statusPill: document.getElementById("statusPill"),

  paletteContent: document.getElementById("paletteContent"),
  paletteChannels: document.getElementById("paletteChannels"),
  paletteActions: document.getElementById("paletteActions"),

  projectSearch: document.getElementById("projectSearch"),
  projectList: document.getElementById("projectList"),

  templateSelect: document.getElementById("templateSelect"),
  btnLoadTemplate: document.getElementById("btnLoadTemplate"),
  btnSaveTemplate: document.getElementById("btnSaveTemplate"),
  btnManageTemplates: document.getElementById("btnManageTemplates"),
  templateImportFile: document.getElementById("templateImportFile"),

  inspectorForm: document.getElementById("inspectorForm"),
  noSelection: document.getElementById("noSelection"),

  fKind: document.getElementById("fKind"),
  fTitle: document.getElementById("fTitle"),
  fLevel: document.getElementById("fLevel"),
  fLang: document.getElementById("fLang"),
  fTiming: document.getElementById("fTiming"),
  fOwner: document.getElementById("fOwner"),
  fBody: document.getElementById("fBody"),
  fAlt: document.getElementById("fAlt"),
  fTranscript: document.getElementById("fTranscript"),
  btnApply: document.getElementById("btnApply"),
  btnDelete: document.getElementById("btnDelete"),

  btnSave: document.getElementById("btnSave"),
  btnLoad: document.getElementById("btnLoad"),
  btnExportJson: document.getElementById("btnExportJson"),
  btnReport: document.getElementById("btnReport"),
  btnReset: document.getElementById("btnReset"),

  btnExportTxt: document.getElementById("btnExportTxt"),
  btnExportWord: document.getElementById("btnExportWord"),
  btnExportPdf: document.getElementById("btnExportPdf"),

  modalBack: document.getElementById("modalBack"),
  modalTitle: document.getElementById("modalTitle"),
  modalHint: document.getElementById("modalHint"),
  modalPre: document.getElementById("modalPre"),
  btnCloseModal: document.getElementById("btnCloseModal"),

  // resizers
  resizerLeft: document.getElementById("resizerLeft"),
  resizerRight: document.getElementById("resizerRight"),
  paletteCols: document.getElementById("paletteCols"),
  palResizer1: document.getElementById("palResizer1"),
  palResizer2: document.getElementById("palResizer2"),

  printMeta: document.getElementById("printMeta"),
  printBox: document.getElementById("printBox"),
};

/* =============================================================================
   Projects (Option B)
   ============================================================================= */
function renderProjects(filterText=""){
  const q = filterText.trim().toLowerCase();
  els.projectList.innerHTML = "";

  const list = PROJECTS.filter(p => !q || (p.title + " " + p.desc + " " + p.badge).toLowerCase().includes(q));

  for (const p of list){
    const el = document.createElement("div");
    el.className = "projectItem" + (p.id === selectedProjectId ? " active" : "");
    el.dataset.projectId = p.id;

    el.innerHTML = `
      <div class="projectTitle">
        <span>${escapeHtml(p.title)}</span>
        <span class="badge">${escapeHtml(p.badge)}</span>
      </div>
      <div class="projectMeta">${escapeHtml(p.desc)}</div>
    `;

    el.addEventListener("click", () => loadProject(p.id));
    els.projectList.appendChild(el);
  }

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "projectMeta";
    empty.textContent = "Geen projecten gevonden.";
    els.projectList.appendChild(empty);
  }
}

function loadProject(projectId){
  const p = PROJECTS.find(x => x.id === projectId);
  if(!p) return;

  selectedProjectId = p.id;
  renderProjects(els.projectSearch.value);

  // Set lens if specified
  if (p.lens) els.lens.value = p.lens;

  // Ensure templateSelect reflects selection then load
  if (p.templateScopeId){
    els.templateSelect.value = p.templateScopeId;
    loadTemplateIntoCanvas(p.templateScopeId);
  }

  applyLens();
  toast(`Project geladen: ${p.title}`);
}

/* =============================================================================
   Palette (3 columns)
   ============================================================================= */
function renderPalette(filterText=""){
  const q = filterText.trim().toLowerCase();
  els.paletteContent.innerHTML = "";
  els.paletteChannels.innerHTML = "";
  els.paletteActions.innerHTML = "";

  const renderItem = (it) => {
    const itemEl = document.createElement("div");
    itemEl.className = "item";
    itemEl.setAttribute("draggable", "true");
    itemEl.dataset.payload = JSON.stringify(it);

    itemEl.innerHTML = `
      <div class="top">
        <span>${escapeHtml(it.title)}</span>
        <span class="tag">${escapeHtml(it.tag)}</span>
      </div>
      <div class="desc">${escapeHtml(it.desc)}</div>
    `;

    // Drag data store using DataTransfer.setData :contentReference[oaicite:8]{index=8}
    itemEl.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("application/json", itemEl.dataset.payload);
      e.dataTransfer.effectAllowed = "copy";
    });

    return itemEl;
  };

  for (const it of PALETTE_ITEMS){
    const hay = (it.title + " " + it.desc + " " + it.kind + " " + it.tag).toLowerCase();
    if (q && !hay.includes(q)) continue;

    if (it.tag === "Content") els.paletteContent.appendChild(renderItem(it));
    else if (it.tag === "Kanaal") els.paletteChannels.appendChild(renderItem(it));
    else if (it.tag === "Actie") els.paletteActions.appendChild(renderItem(it));
    else els.paletteContent.appendChild(renderItem(it));
  }
}

/* =============================================================================
   Canvas render
   ============================================================================= */
function renderCanvas(){
  els.canvas.innerHTML = "";

  PHASES.forEach(phase => {
    const phaseEl = document.createElement("section");
    phaseEl.className = "phase";
    phaseEl.dataset.phaseId = phase.id;

    const hdr = document.createElement("div");
    hdr.className = "phaseTitle";
    hdr.innerHTML = `<h3>${escapeHtml(phase.title)}</h3><div class="meta">Drop blokken in lanes</div>`;
    phaseEl.appendChild(hdr);

    AUDIENCES.forEach(aud => {
      const lanes = document.createElement("div");
      lanes.className = "lanes";

      const label = document.createElement("div");
      label.className = "laneLabel";
      label.innerHTML = `<b>${escapeHtml(aud.label)}</b><br/>${escapeHtml(aud.hint)}`;
      lanes.appendChild(label);

      const drop = document.createElement("div");
      drop.className = "laneDrop";
      drop.tabIndex = 0;
      drop.dataset.phaseId = phase.id;
      drop.dataset.audienceId = aud.id;

      const hint = document.createElement("div");
      hint.className = "laneHint";
      hint.textContent = "Drop hier…";
      drop.appendChild(hint);

      drop.addEventListener("dragover", (e) => {
        e.preventDefault();
        drop.classList.add("dragover");
        e.dataTransfer.dropEffect = "copy";
      });
      drop.addEventListener("dragleave", () => drop.classList.remove("dragover"));

      drop.addEventListener("drop", (e) => {
        e.preventDefault();
        drop.classList.remove("dragover");
        const payload = e.dataTransfer.getData("application/json");
        if(!payload) return;

        const it = JSON.parse(payload);
        const rect = drop.getBoundingClientRect();
        const x = (e.clientX - rect.left) + drop.scrollLeft;
        const y = (e.clientY - rect.top) + drop.scrollTop;

        addNode({
          kind: it.kind, tag: it.tag, title: it.title, body: it.desc,
          phaseId: phase.id, audienceId: aud.id,
          x: clamp(x-120, 10, rect.width-260),
          y: clamp(y-24, 32, rect.height-90),
          level: suggestLevel(aud.id),
          lang: suggestLang(aud.id),
          timing: suggestTiming(phase.id),
          transcript: (it.kind === "studio_video" || it.kind === "fragment" || it.kind === "indiveo") ? "ja" : ""
        });
      });

      lanes.appendChild(drop);
      phaseEl.appendChild(lanes);
    });

    els.canvas.appendChild(phaseEl);
  });

  renderNodes();
  applyLens();
}

function categoryClass(node){
  // Category based on tag/kind for consistent coloring in library + swimlanes
  const tag = (node.tag || "").toLowerCase();
  if (tag === "inforium" || tag === "studio" || tag === "content") return "cat-content";
  if (tag === "kanaal" || tag === "app" || tag === "tool") return "cat-channel";
  if (tag === "actie") return "cat-action";
  // fallback heuristic
  const k = (node.kind || "").toLowerCase();
  if (k.includes("inforium") || k.includes("video") || k.includes("thuisarts") || k.includes("folder") || k.includes("webpage")) return "cat-content";
  if (k.includes("portaal") || k.includes("website") || k.includes("luscii") || k.includes("journey") || k.includes("beter")) return "cat-channel";
  return "cat-action";
}

function renderNodes(){
  document.querySelectorAll(".laneDrop .node").forEach(n => n.remove());
  const lanes = [...document.querySelectorAll(".laneDrop")];

  for (const node of state.nodes){
    const lane = lanes.find(l => l.dataset.phaseId === node.phaseId && l.dataset.audienceId === node.audienceId);
    if(!lane) continue;

    const hint = lane.querySelector(".laneHint");
    if (hint) hint.style.display = "none";

    const el = document.createElement("div");
    el.className = "node " + categoryClass(node);
    el.tabIndex = 0;
    el.dataset.nodeId = node.id;
    el.style.left = node.x + "px";
    el.style.top = node.y + "px";

    el.innerHTML = `
      <div class="hdr">
        <span class="title">${escapeHtml(node.title)}</span>
        <div class="hdrRight">
          <span class="kind">${escapeHtml(node.tag || node.kind)}</span>
          <button class="nodeDel" type="button" title="Verwijderen">×</button>
        </div>
      </div>
      <div class="body"><b>Bron:</b> ${escapeHtml(node.owner || "—")}</div>
      <div class="body">${escapeHtml(node.body || "")}</div>

      <div class="chips">
        ${node.level ? `<span class="chip">Niveau: ${escapeHtml(node.level)}</span>` : ``}
        ${node.lang ? `<span class="chip">Taal: ${escapeHtml(node.lang)}</span>` : ``}
        ${node.timing ? `<span class="chip">Timing: ${escapeHtml(node.timing)}</span>` : ``}
      </div>
    `;

    el.addEventListener("click", () => selectNode(node.id));

    const delBtn = el.querySelector(".nodeDel");
    delBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      deleteNode(node.id);
    });
el.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter") selectNode(node.id);
      if (ev.key === "Delete") deleteNode(node.id);
    });

    makeMovable(el, lane);
    lane.appendChild(el);
  }

  document.querySelectorAll(".laneDrop").forEach(lane => {
    const has = lane.querySelector(".node");
    const hint = lane.querySelector(".laneHint");
    if (hint) hint.style.display = has ? "none" : "block";
  });

  updateSelectedStyles();
  updateCounts();

  // After DOM is updated, pack nodes to avoid overlaps
  requestAnimationFrame(packAllLanes);
}


/* =============================================================================
   Overlap prevention in swimlanes
   - Nodes are absolutely positioned. After drops/moves we "pack" nodes top-down
     (keeping X) so they don't overlap.
   ============================================================================= */
function packLane(laneEl){
  const nodeEls = Array.from(laneEl.querySelectorAll(".node"));
  if(!nodeEls.length) return;

  // sort by current y
  nodeEls.sort((a,b) => (getNode(a.dataset.nodeId)?.y ?? 0) - (getNode(b.dataset.nodeId)?.y ?? 0));

  let cursorY = 32;         // leave room under lane header/hint area
  const gap = 10;

  for (const el of nodeEls){
    const n = getNode(el.dataset.nodeId);
    if(!n) continue;

    // ensure node stays within lane height; allow scrolling if overflow
    const h = el.offsetHeight || 90;
    n.y = Math.max(n.y, cursorY);
    el.style.top = n.y + "px";
    cursorY = n.y + h + gap;
  }
}

function packAllLanes(){
  document.querySelectorAll(".laneDrop").forEach(packLane);
}

function makeMovable(nodeEl, laneEl){
  let dragging = false;
  let startX=0, startY=0, origX=0, origY=0;

  nodeEl.addEventListener("mousedown", (e) => {
    dragging = true;
    selectNode(nodeEl.dataset.nodeId);
    startX = e.clientX; startY = e.clientY;
    const n = getNode(nodeEl.dataset.nodeId);
    origX = n.x; origY = n.y;
    nodeEl.style.cursor = "grabbing";
    e.preventDefault();
  });

  window.addEventListener("mousemove", (e) => {
    if(!dragging) return;
    const id = nodeEl.dataset.nodeId;
    const n = getNode(id);
    const rect = laneEl.getBoundingClientRect();

    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    n.x = clamp(origX + dx, 10, rect.width - 260);
    n.y = clamp(origY + dy, 32, rect.height - 90);

    nodeEl.style.left = n.x + "px";
    nodeEl.style.top  = n.y + "px";
    setDirty(true);
  });

  window.addEventListener("mouseup", () => {
    if(!dragging) return;
    dragging = false;
    nodeEl.style.cursor = "move";
    // Pack lane to avoid overlaps after moving
    packLane(laneEl);
  });
}

/* =============================================================================
   State ops
   ============================================================================= */
function addNode(partial){
  const id = cryptoId();
  const node = {
    id,
    kind: partial.kind || "blok",
    tag: partial.tag || "Content",
    title: partial.title || "Nieuw blok",
    body: partial.body || "",
    phaseId: partial.phaseId,
    audienceId: partial.audienceId,
    x: partial.x ?? 20,
    y: partial.y ?? 40,
    level: partial.level || "",
    lang: partial.lang || "",
    timing: partial.timing || "",
    owner: partial.owner || "Zorgorganisatie / afdeling",
    alt: partial.alt || "",
    transcript: partial.transcript || "",
  };
  state.nodes.push(node);
  selectNode(id);
  renderNodes();
  setDirty(true);
}

function getNode(id){ return state.nodes.find(n => n.id === id); }

function selectNode(id){
  state.selectedNodeId = id;
  updateInspector();
  updateSelectedStyles();
}

function updateSelectedStyles(){
  document.querySelectorAll(".node").forEach(el => {
    el.classList.toggle("selected", el.dataset.nodeId === state.selectedNodeId);
  });
}

function updateInspector(){
  const n = getNode(state.selectedNodeId);
  if(!n){
    els.noSelection.style.display = "block";
    els.inspectorForm.style.display = "none";
    return;
  }
  els.noSelection.style.display = "none";
  els.inspectorForm.style.display = "block";

  els.fKind.value = n.kind;
  els.fTitle.value = n.title;
  els.fLevel.value = n.level;
  els.fLang.value = n.lang;
  els.fTiming.value = n.timing;
  els.fOwner.value = n.owner;
  els.fBody.value = n.body;
  els.fAlt.value = n.alt;
  els.fTranscript.value = n.transcript;
}

function applyInspector(){
  const n = getNode(state.selectedNodeId);
  if(!n) return;

  n.title = els.fTitle.value.trim() || n.title;
  n.level = els.fLevel.value.trim();
  n.lang = els.fLang.value.trim();
  n.timing = els.fTiming.value.trim();
  n.owner = els.fOwner.value.trim();
  n.body = els.fBody.value.trim();
  n.alt = els.fAlt.value.trim();
  n.transcript = els.fTranscript.value.trim();

  renderNodes();
  setDirty(true);
}

function deleteNode(id){
  const idx = state.nodes.findIndex(n => n.id === id);
  if(idx < 0) return;
  state.nodes.splice(idx, 1);
  if(state.selectedNodeId === id) state.selectedNodeId = null;
  renderNodes();
  updateInspector();
  setDirty(true);
}

function resetAll(){
  state = { nodes: [], selectedNodeId: null, dirty:false };
  renderCanvas();
  updateInspector();
  setDirty(false);
}

/* =============================================================================
   Lens
   ============================================================================= */
function applyLens(){
  const lens = els.lens.value;
  document.querySelectorAll(".lanes").forEach(row => {
    const drop = row.querySelector(".laneDrop");
    if(!drop) return;
    const aud = drop.dataset.audienceId;
    row.style.display = (lens === "all" || lens === aud) ? "grid" : "none";
  });
}

/* =============================================================================
   Save/load canvas (localStorage)  :contentReference[oaicite:9]{index=9}
   ============================================================================= */
function save(){
  const payload = { version: 5, savedAt: new Date().toISOString(), nodes: state.nodes };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  setDirty(false);
  toast("Canvas opgeslagen.");
}
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ toast("Geen opgeslagen canvas gevonden."); return; }
  const payload = JSON.parse(raw);
  state.nodes = payload.nodes || [];
  state.selectedNodeId = null;
  renderNodes();
  updateInspector();
  setDirty(false);
  toast("Canvas geladen.");
}

/* =============================================================================
   Exports (TXT / Word / PDF / JSON)
   ============================================================================= */
function exportJson(){
  const payload = {
    version: 5,
    exportedAt: new Date().toISOString(),
    phases: PHASES,
    audiences: AUDIENCES,
    nodes: state.nodes
  };
  openModal("Export JSON", "Kopieer dit JSON (input voor dev/low-code).", JSON.stringify(payload, null, 2));
}

function exportTxt(){
  const text = buildReportText();
  downloadBlob(text, `inforium-canvas-report-${todayStamp()}.txt`, "text/plain;charset=utf-8");
}

function exportWord(){
  const html = buildWordHtml();
  downloadBlob(html, `inforium-canvas-report-${todayStamp()}.doc`, "application/msword");
}

function exportPdf(){
  const text = buildReportText();
  els.printMeta.textContent = `Datum: ${new Date().toLocaleString()} | Nodes: ${state.nodes.length}`;
  els.printBox.textContent = text;
  window.print(); // :contentReference[oaicite:10]{index=10}
}

/* =============================================================================
   Templates: load/save/export/import
   ============================================================================= */
function getUserTemplates(){
  const raw = localStorage.getItem(TEMPLATES_USER_KEY);
  if(!raw) return [];
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function setUserTemplates(templates){
  localStorage.setItem(TEMPLATES_USER_KEY, JSON.stringify(templates));
}

function refreshTemplateSelect(){
  const user = getUserTemplates();
  const all = [
    ...TEMPLATES_BUILTIN.map(t => ({...t, scope:"built-in"})),
    ...user.map(t => ({...t, scope:"user"})),
  ];

  els.templateSelect.innerHTML = "";
  for (const t of all){
    const opt = document.createElement("option");
    opt.value = `${t.scope}:${t.id}`;
    opt.textContent = `${t.scope === "built-in" ? "★ " : "✎ "}${t.name}`;
    opt.title = t.description || "";
    els.templateSelect.appendChild(opt);
  }
}

function resolveTemplate(scopeId){
  const [scope, id] = scopeId.split(":");
  if (scope === "built-in") return TEMPLATES_BUILTIN.find(t => t.id === id) || null;
  const user = getUserTemplates();
  return user.find(t => t.id === id) || null;
}

function loadTemplateIntoCanvas(scopeId){
  const t = resolveTemplate(scopeId);
  if(!t){ toast("Sjabloon niet gevonden."); return; }

  const nodes = (t.nodes || []).map(n => ({
    ...n,
    id: cryptoId(),
  }));

  // Fix placeholder ids if any
  for (const n of nodes){
    if (n.id === "TEMPLATE_NODE_ID") n.id = cryptoId();
  }

  state.nodes = nodes;
  state.selectedNodeId = null;
  renderNodes();
  updateInspector();
  setDirty(true);
  toast(`Sjabloon geladen: ${t.name}`);
}

function saveCurrentAsTemplate(){
  const name = prompt("Naam voor dit sjabloon:", "Mijn sjabloon");
  if(!name) return;

  const user = getUserTemplates();
  const tpl = {
    id: cryptoId(),
    name: name.trim(),
    description: "Custom sjabloon (lokaal opgeslagen)",
    createdAt: new Date().toISOString(),
    nodes: state.nodes.map(n => ({ ...n, id: "TEMPLATE_NODE_ID" })),
  };

  user.unshift(tpl);
  setUserTemplates(user);
  refreshTemplateSelect();
  toast("Sjabloon opgeslagen (lokaal).");
}

function exportAllTemplates(){
  const payload = {
    exportedAt: new Date().toISOString(),
    builtin: TEMPLATES_BUILTIN,
    user: getUserTemplates(),
  };
  downloadBlob(JSON.stringify(payload, null, 2), `inforium-templates-${todayStamp()}.json`, "application/json;charset=utf-8");
}

function importTemplatesFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const payload = JSON.parse(String(reader.result || "{}"));
      const importedUser = payload.user || payload.templates || [];
      if (!Array.isArray(importedUser)) throw new Error("Invalid templates format");

      const current = getUserTemplates();
      const merged = [...importedUser, ...current]
        .filter(t => t && t.id && t.name && Array.isArray(t.nodes));

      setUserTemplates(merged);
      refreshTemplateSelect();
      toast(`Templates geïmporteerd (${importedUser.length}).`);
    }catch(e){
      alert("Import mislukt: geen geldig templates JSON.");
    }
  };
  reader.readAsText(file);
}

function manageTemplatesModal(){
  const userCount = getUserTemplates().length;
  const txt =
`SJABLONEN BEHEER
================
Built-in sjablonen: ${TEMPLATES_BUILTIN.length}
Eigen sjablonen (lokaal): ${userCount}

Acties:
- Export: download JSON met built-in + eigen sjablonen
- Import: voeg sjablonen toe vanuit JSON bestand
- Clear: wis alleen eigen sjablonen

Let op: eigen sjablonen staan lokaal in je browser (localStorage).
`;
  openModal("Sjablonen beheren", "Gebruik de prompt voor export/import/clear.", txt);

  setTimeout(() => {
    const action = prompt("Typ: export | import | clear | cancel", "export");
    if(!action) return;
    if(action.toLowerCase() === "export") exportAllTemplates();
    if(action.toLowerCase() === "import") els.templateImportFile.click();
    if(action.toLowerCase() === "clear"){
      if(confirm("Weet je het zeker? Dit wist alleen jouw eigen sjablonen.")){
        setUserTemplates([]);
        refreshTemplateSelect();
        toast("Eigen sjablonen gewist.");
      }
    }
  }, 60);
}

/* =============================================================================
   Report builders
   ============================================================================= */
function buildReportText(){
  const byPhase = Object.fromEntries(PHASES.map(p => [p.id, []]));
  const byAudience = Object.fromEntries(AUDIENCES.map(a => [a.id, []]));
  for (const n of state.nodes){
    if (byPhase[n.phaseId]) byPhase[n.phaseId].push(n);
    if (byAudience[n.audienceId]) byAudience[n.audienceId].push(n);
  }

  const lines = [];
  lines.push("INFORIUM COMMUNICATION CANVAS — RAPPORT");
  lines.push("=====================================");
  lines.push(`Datum: ${new Date().toLocaleString()}`);
  lines.push(`Totaal nodes: ${state.nodes.length}`);
  lines.push("");

  lines.push("1) Overzicht per fase");
  for (const p of PHASES){
    lines.push(`- ${p.title}: ${byPhase[p.id].length} blok(ken)`);
    for (const n of byPhase[p.id].slice(0, 14)){
      lines.push(`  • [${n.audienceId}] ${n.title} (${n.tag}) | ${n.timing || "-"} | ${n.lang || "-"} | ${n.level || "-"}`);
    }
  }
  lines.push("");

  lines.push("2) Overzicht per doelgroep");
  for (const a of AUDIENCES){
    lines.push(`- ${a.label}: ${byAudience[a.id].length} blok(ken)`);
  }
  lines.push("");

  lines.push("3) Gaps (snelle checks)");
  const gaps = [];
  for (const n of state.nodes){
    if (n.audienceId === "laaggeletterd" && !/A2|B1/i.test(n.level || "")){
      gaps.push(`- Laaggeletterd: "${n.title}" mist A2/B1 instelling.`);
    }
    if (n.audienceId === "anderstalig" && !/auto|\(auto\)|\+/i.test(n.lang || "")){
      gaps.push(`- Anderstalig: "${n.title}" mist taal/auto-vertaling hint.`);
    }
    if (n.audienceId === "digitaal_savvy" && !/(link|deeplink|portaal|app|qr|beter)/i.test((n.body || "") + " " + (n.title || ""))){
      gaps.push(`- Digitaal savvy: "${n.title}" mist self-service kanaal hint.`);
    }
  }
  if(!gaps.length) gaps.push("- Geen opvallende gaps op basis van deze checks.");
  lines.push(gaps.slice(0, 24).join("\n"));
  lines.push("");

  return lines.join("\n");
}

function buildWordHtml(){
  const text = buildReportText()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  return `
  <!doctype html><html><head><meta charset="utf-8">
    <title>Inforium Report</title>
    <style>
      body{ font-family: Calibri, Arial, sans-serif; color:#1b2a3a; }
      h1{ font-size:18pt; margin:0 0 8pt; }
      .meta{ color:#6c7c93; margin:0 0 12pt; }
      pre{ white-space:pre-wrap; font-family: Consolas, Menlo, monospace; font-size:10.5pt; }
    </style>
  </head>
  <body>
    <h1>Inforium Communication Canvas — Rapport</h1>
    <div class="meta">Datum: ${new Date().toLocaleString()} | Nodes: ${state.nodes.length}</div>
    <pre>${text}</pre>
  </body></html>`;
}

/* =============================================================================
   Download helper (Blob + createObjectURL + revokeObjectURL)
   :contentReference[oaicite:11]{index=11}
   ============================================================================= */
function downloadBlob(content, filename, mimeType){
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}
function todayStamp(){
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
}

/* =============================================================================
   UI helpers
   ============================================================================= */
function setDirty(v){
  state.dirty = v;
  els.statusPill.textContent = v ? "Niet opgeslagen" : "Opgeslagen";
  els.statusPill.style.borderColor = v ? "rgba(214,74,74,.35)" : "rgba(42,157,111,.35)";
  els.statusPill.style.background = v ? "rgba(214,74,74,.08)" : "rgba(42,157,111,.10)";
}
function updateCounts(){ els.countPill.textContent = `${state.nodes.length} nodes`; }
function toast(msg){
  const old = els.statusPill.textContent;
  els.statusPill.textContent = msg;
  setTimeout(() => { els.statusPill.textContent = old; }, 1400);
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
function cryptoId(){
  return (crypto?.randomUUID?.() || ("id-" + Math.random().toString(16).slice(2))).slice(0, 18);
}

/* =============================================================================
   Defaults
   ============================================================================= */
function suggestLevel(audienceId){
  if (audienceId === "laaggeletterd") return "A2/B1";
  if (audienceId === "digitaal_savvy") return "B1";
  return "B1";
}
function suggestLang(audienceId){
  if (audienceId === "anderstalig") return "NL + (auto)";
  return "NL";
}
function suggestTiming(phaseId){
  if (phaseId === "vooraf") return "T-7";
  if (phaseId === "dagzelf") return "T0";
  if (phaseId === "nazorg") return "T+1";
  return "";
}

/* =============================================================================
   Modal
   ============================================================================= */
function openModal(title, hint, text){
  els.modalTitle.textContent = title;
  els.modalHint.textContent = hint;
  els.modalPre.textContent = text;
  els.modalBack.style.display = "flex";
}
function closeModal(){ els.modalBack.style.display = "none"; }

/* =============================================================================
   Events
   ============================================================================= */
els.search.addEventListener("input", () => renderPalette(els.search.value));
els.lens.addEventListener("change", applyLens);

els.projectSearch.addEventListener("input", () => renderProjects(els.projectSearch.value));

els.btnApply.addEventListener("click", applyInspector);
els.btnDelete.addEventListener("click", () => { if(state.selectedNodeId) deleteNode(state.selectedNodeId); });

els.btnSave.addEventListener("click", save);
els.btnLoad.addEventListener("click", load);

els.btnExportJson.addEventListener("click", exportJson);
els.btnReport.addEventListener("click", () => openModal("Rapport preview", "Tekstversie (zelfde basis als TXT/Word/PDF).", buildReportText()));
els.btnReset.addEventListener("click", () => { if(confirm("Alles resetten?")) resetAll(); });

els.btnExportTxt.addEventListener("click", exportTxt);
els.btnExportWord.addEventListener("click", exportWord);
els.btnExportPdf.addEventListener("click", exportPdf);

els.btnCloseModal.addEventListener("click", closeModal);
els.modalBack.addEventListener("click", (e) => { if(e.target === els.modalBack) closeModal(); });

window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeModal();
  if (e.key === "Delete" && state.selectedNodeId) deleteNode(state.selectedNodeId);
});

els.btnLoadTemplate.addEventListener("click", () => loadTemplateIntoCanvas(els.templateSelect.value));
els.btnSaveTemplate.addEventListener("click", saveCurrentAsTemplate);
els.btnManageTemplates.addEventListener("click", manageTemplatesModal);
els.templateImportFile.addEventListener("change", (e) => {
  const f = e.target.files?.[0];
  if(f) importTemplatesFromFile(f);
  e.target.value = "";
});

/* =============================================================================
   Init
   ============================================================================= */

/* =============================================================================
   Resizers (Panels + Palette columns)
   - Uses Pointer Events + setPointerCapture (smooth dragging)
   ============================================================================= */
function initAppResizers(){
  // Left panel width
  makeHResizer(els.resizerLeft, "leftWidth", 420, 820);
  // Right panel width
  makeHResizer(els.resizerRight, "rightWidth", 280, 520);
}

function initPaletteResizers(){
  // Default: equal columns (we keep as fr initially)
  // On first resize, we switch to pixel widths for predictability.
  const colsEl = els.paletteCols;
  if(!colsEl) return;

  const ensurePixelVars = () => {
    const w = colsEl.getBoundingClientRect().width;
    const gap = 10; // matches CSS gap
    const handle = 8; // resizer width
    const usable = Math.max(300, w - (2*handle) - (4*gap));
    const each = Math.max(180, usable/3);
    const root = document.documentElement.style;
    if(!getComputedStyle(document.documentElement).getPropertyValue("--palW1").trim()){
      root.setProperty("--palW1", `${each}px`);
      root.setProperty("--palW2", `${each}px`);
      root.setProperty("--palW3", `${each}px`);
    }
  };

  ensurePixelVars();
  makePaletteResizer(els.palResizer1, 1);
  makePaletteResizer(els.palResizer2, 2);
}

function makeHResizer(handleEl, cssVarName, minPx, maxPx){
  if(!handleEl) return;
  handleEl.addEventListener("pointerdown", (ev) => {
    ev.preventDefault();
    handleEl.setPointerCapture(ev.pointerId);
    const startX = ev.clientX;
    const root = document.documentElement;
    const start = parseInt(getComputedStyle(root).getPropertyValue(`--${cssVarName}`)) || (cssVarName==="leftWidth" ? 560 : 360);

    const onMove = (e) => {
      const dx = e.clientX - startX;
      const next = clamp(start + dx, minPx, maxPx);
      root.style.setProperty(`--${cssVarName}`, `${next}px`);
    };
    const onUp = () => {
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", onUp);
    };
    window.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp, { once:true });
  });
}

function makePaletteResizer(handleEl, which){
  if(!handleEl) return;
  handleEl.addEventListener("pointerdown", (ev) => {
    ev.preventDefault();
    handleEl.setPointerCapture(ev.pointerId);

    const root = document.documentElement;
    const colsEl = els.paletteCols;
    const rect = colsEl.getBoundingClientRect();

    const startX = ev.clientX;
    const w1 = parseInt(getComputedStyle(root).getPropertyValue("--palW1")) || Math.round(rect.width/3);
    const w2 = parseInt(getComputedStyle(root).getPropertyValue("--palW2")) || Math.round(rect.width/3);
    const w3 = parseInt(getComputedStyle(root).getPropertyValue("--palW3")) || Math.round(rect.width/3);

    const min = 160;

    const onMove = (e) => {
      const dx = e.clientX - startX;

      if(which === 1){
        const newW1 = clamp(w1 + dx, min, rect.width - (min*2));
        const newW2 = clamp(w2 - dx, min, rect.width - (min*2));
        root.style.setProperty("--palW1", `${newW1}px`);
        root.style.setProperty("--palW2", `${newW2}px`);
        root.style.setProperty("--palW3", `${w3}px`);
      } else {
        const newW2 = clamp(w2 + dx, min, rect.width - (min*2));
        const newW3 = clamp(w3 - dx, min, rect.width - (min*2));
        root.style.setProperty("--palW1", `${w1}px`);
        root.style.setProperty("--palW2", `${newW2}px`);
        root.style.setProperty("--palW3", `${newW3}px`);
      }
    };

    const onUp = () => {
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", onUp);
    };
    window.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp, { once:true });
  });
}

renderPalette("");
initAppResizers();
initPaletteResizers();
renderCanvas();
updateInspector();
setDirty(false);
refreshTemplateSelect();
renderProjects("");

/* Auto: laad eerste project (zodat demo direct gevuld is) */
loadProject(PROJECTS[0].id);

/* =============================================================================
   BUILT-IN TEMPLATES (8)
   ============================================================================= */
function baseTemplate(id, name, description, nodes){
  return { id, name, description, nodes };
}
function node(phaseId, audienceId, x, y, kind, tag, title, body, timing, level, lang){
  return {
    id: "TEMPLATE_NODE_ID",
    phaseId, audienceId, x, y,
    kind, tag, title, body,
    timing: timing || "", level: level || "", lang: lang || "",
    owner: "Zorgorganisatie / afdeling",
    alt: "", transcript: ""
  };
}

/* --- POLI: NORMAAL --- */
function templatePoliNormaal(){
  const a = "normaal";
  return baseTemplate(
    "poli_normaal",
    "Polikliniekbezoek — Normaal (B1)",
    "Standaard flow: afspraak + route + voorbereiding + nabehandeling.",
    [
      node("vooraf", a, 24, 30, "inforium_item","Content","Afspraak bevestigd","Wat is de afspraak + datum/tijd + locatie.","T-7","B1","NL"),
      node("vooraf", a, 24, 170,"webpage","Content","Route & parkeren","Ziekenhuis webpagina met route/parkeren/plattegrond.","T-7","B1","NL"),
      node("vooraf", a, 290,30,"send_link","Actie","Stuur link","E-mail/app met deeplink naar route + voorbereiding.","T-7","B1","NL"),
      node("vooraf", a, 290,170,"reminder","Actie","Reminder met knoppen","Bevestig / Wijzig / Zeg af.","T-2","B1","NL"),
      node("dagzelf", a, 24, 30,"mondeling","Kanaal","Aanmelden balie / zuil","Wat neem je mee: ID, verwijsbrief, bril.","T0","B1","NL"),
      node("dagzelf", a, 290,30,"inforium_item","Content","Op de poli","Waar meld je je + wachtruimte + verloop consult.","T0","B1","NL"),
      node("nazorg", a, 24, 30,"inforium_item","Content","Nazorg / vervolg","Wat nu: uitslag, vervolgafspraak, contact.","T+1","B1","NL"),
      node("nazorg", a, 290,30,"feedback","Actie","Korte feedback","1 minuut evaluatie (begrip + ervaring).","T+2","B1","NL"),
    ]
  );
}

/* --- POLI: LAAGGELETTERD --- */
function templatePoliLaaggeletterd(){
  const a = "laaggeletterd";
  return baseTemplate(
    "poli_lg",
    "Polikliniekbezoek — Laaggeletterd (A2/B1)",
    "Kort, 1 ding per scherm, pictogrammen/QR, check begrip.",
    [
      node("vooraf", a, 24, 30, "studio_video","Content","Video: zo komt u binnen","Korte video: route, ingang, aanmelden.","T-7","A2/B1","NL"),
      node("vooraf", a, 290,30,"send_qr","Actie","QR naar telefoon","QR naar video + eenvoudige checklist.","T-7","A2/B1","NL"),
      node("vooraf", a, 24, 170,"folder","Content","1-pager folder","A2: datum/tijd/plek + wat meenemen.","T-7","A2/B1","NL"),
      node("vooraf", a, 290,170,"check_begrip","Actie","Check begrip","2 vragen: Wanneer? Waar? Wat meenemen?","T-6","A2/B1","NL"),
      node("vooraf", a, 24, 310,"reminder","Actie","Reminder heel kort","“Uw afspraak is morgen. Komt u?” + 2 knoppen.","T-1","A2/B1","NL"),
      node("dagzelf", a, 24, 30,"mondeling","Kanaal","Balie helpt","Gebruik vaste zinnen + herhaal belangrijkste.","T0","A2/B1","NL"),
      node("nazorg", a, 290,30,"inforium_item","Content","Nazorg in 3 stappen","1) rust 2) medicijnen 3) bellen bij…","T+1","A2/B1","NL"),
      node("followup", a, 24, 30,"fallback","Actie","Als geen reactie","Bel-lijst / contactpersoon voor follow-up.","T+2","A2/B1","NL"),
    ]
  );
}

/* --- POLI: ANDERSTALIG --- */
function templatePoliAnderstalig(){
  const a = "anderstalig";
  return baseTemplate(
    "poli_anders",
    "Polikliniekbezoek — Anderstalig (NL + auto)",
    "Meertalige flow met simpele taal + visueel + kanaalkeuze.",
    [
      node("vooraf", a, 24, 30,"inforium_item","Content","Afspraak (meertalig)","Tekst in NL + auto-vertaling naar taal patiënt.","T-7","B1","NL + (auto)"),
      node("vooraf", a, 290,30,"studio_video","Content","Video met ondertitels","Video route + aanmelden, ondertitels meertalig.","T-7","B1","NL + (auto)"),
      node("vooraf", a, 24, 170,"send_link","Actie","Stuur link (taal)","App/e-mail met deeplink in gekozen taal.","T-7","B1","NL + (auto)"),
      node("vooraf", a, 290,170,"reminder","Actie","Reminder in taal","Kort + knoppen bevestigen/wijzigen/afzeggen.","T-2","B1","NL + (auto)"),
      node("dagzelf", a, 24, 30,"mondeling","Kanaal","Tolk/ondersteuning","Als nodig: tolktelefoon of pictokaart.","T0","B1","NL + (auto)"),
      node("nazorg", a, 290,30,"inforium_item","Content","Nazorg meertalig","Waarschuwingssignalen + contact in taal.","T+1","B1","NL + (auto)"),
      node("nazorg", a, 24, 30,"fallback","Actie","Alternatief kanaal","Geen portal? Gebruik app/print als alternatief.","T+1","B1","NL + (auto)"),
    ]
  );
}

/* --- POLI: DIGITAAL SAVVY --- */
function templatePoliDigitaal(){
  const a = "digitaal_savvy";
  return baseTemplate(
    "poli_digitaal",
    "Polikliniekbezoek — Digitaal savvy (self-service)",
    "Alles via app/portaal: deeplinks, knoppen, reminders, check-in.",
    [
      node("vooraf", a, 24, 30,"portaal","Kanaal","Portaal bericht","Alles in 1 bericht: route, voorbereiding, contact.","T-7","B1","NL"),
      node("vooraf", a, 290,30,"vragenlijst","Kanaal","Digitale intake","Korte intake + medicatie + klachten.","T-5","B1","NL"),
      node("vooraf", a, 24, 170,"beterdichtbij","Kanaal","BeterDichtbij flow","Push + knoppen + chat bij vragen.","T-5","B1","NL"),
      node("vooraf", a, 290,170,"reminder","Actie","2 reminders","T-2 en T-1, met 1-klik actie.","T-2","B1","NL"),
      node("dagzelf", a, 24, 30,"send_qr","Actie","QR check-in","QR in app voor snelle aanmelding.","T0","B1","NL"),
      node("nazorg", a, 290,30,"inforium_item","Content","Nazorg + afspraak plannen","Link naar agenda/afspraakmodule.","T+1","B1","NL"),
      node("followup", a, 24, 30,"feedback","Actie","Feedback in app","NPS + begrip-check.","T+3","B1","NL"),
    ]
  );
}

/* --- VERRICHTING/OPERATIE: NORMAAL --- */
function templateVerrichtingNormaal(){
  const a = "normaal";
  return baseTemplate(
    "verr_normaal",
    "Verrichting/operatie — Normaal (B1)",
    "Voorbereiding (nuchter/medicatie), dag zelf, nazorg + alarmsymptomen.",
    [
      node("vooraf", a, 24, 30,"inforium_item","Content","Voorbereiding","Nuchter? Medicatie? Wat meenemen?","T-7","B1","NL"),
      node("vooraf", a, 290,30,"studio_video","Content","Video: wat gebeurt er","Uitleg verrichting + wat voelt u.","T-7","B1","NL"),
      node("vooraf", a, 24, 170,"vragenlijst","Kanaal","Checklist / contra-indicaties","Allergieën, antistolling, vervoer naar huis.","T-5","B1","NL"),
      node("vooraf", a, 290,170,"reminder","Actie","Reminder nuchter/medicatie","T-1: laatste check, knoppen: OK / vraag.","T-1","B1","NL"),
      node("dagzelf", a, 24, 30,"mondeling","Kanaal","Instructie op locatie","Herhaal belangrijkste + toestemming.","T0","B1","NL"),
      node("nazorg", a, 290,30,"inforium_item","Content","Nazorg + alarmsignalen","Wanneer bellen? Pijn/koorts/bloedverlies.","T+1","B1","NL"),
      node("followup", a, 24, 30,"send_link","Actie","Uitslag + vervolg","Uitslag in portaal/app + vervolgafspraak.","T+7","B1","NL"),
    ]
  );
}

/* --- VERRICHTING/OPERATIE: LAAGGELETTERD --- */
function templateVerrichtingLaaggeletterd(){
  const a = "laaggeletterd";
  return baseTemplate(
    "verr_lg",
    "Verrichting/operatie — Laaggeletterd (A2/B1)",
    "Heel kort + visueel, 1-pager + video, extra begrip-check, fallback bellen.",
    [
      node("vooraf", a, 24, 30,"studio_video","Content","Video: voorbereiding","Kort: nuchter, medicijnen, vervoer.","T-7","A2/B1","NL"),
      node("vooraf", a, 290,30,"folder","Content","1-pager met pictos","Wat doen / wat niet doen.","T-7","A2/B1","NL"),
      node("vooraf", a, 24, 170,"send_qr","Actie","QR naar checklist","QR naar video + 3 bullets.","T-7","A2/B1","NL"),
      node("vooraf", a, 290,170,"check_begrip","Actie","Begrip-check","“Wanneer stop je met eten?” + “Wie haalt je op?”","T-6","A2/B1","NL"),
      node("vooraf", a, 24, 310,"reminder","Actie","Reminder kort","“Morgen is de verrichting. Nuchter blijven.”","T-1","A2/B1","NL"),
      node("nazorg", a, 24, 30,"inforium_item","Content","Nazorg 3 stappen","Rust • drinken • bellen bij…","T+1","A2/B1","NL"),
      node("followup", a, 290,30,"fallback","Actie","Als twijfel: bel","Belnummer groot + wanneer bellen.","T+1","A2/B1","NL"),
    ]
  );
}

/* --- VERRICHTING/OPERATIE: ANDERSTALIG --- */
function templateVerrichtingAnderstalig(){
  const a = "anderstalig";
  return baseTemplate(
    "verr_anders",
    "Verrichting/operatie — Anderstalig (NL + auto)",
    "Meertalige instructies, extra nadruk op nuchter/medicatie + heldere reminders.",
    [
      node("vooraf", a, 24, 30,"inforium_item","Content","Voorbereiding (meertalig)","NL + auto-vertaling. Nuchter/medicatie/ vervoer.","T-7","B1","NL + (auto)"),
      node("vooraf", a, 290,30,"studio_video","Content","Video met ondertitels","Eenvoudig + ondertiteling in taal patiënt.","T-7","B1","NL + (auto)"),
      node("vooraf", a, 24, 170,"send_link","Actie","Stuur link (taal)","Deeplink naar instructies in gekozen taal.","T-7","B1","NL + (auto)"),
      node("vooraf", a, 290,170,"reminder","Actie","Reminder nuchter","Kort + knoppen (OK / vraag).","T-1","B1","NL + (auto)"),
      node("dagzelf", a, 24, 30,"mondeling","Kanaal","Check met pictokaart","Begrip check op locatie, evt. tolk.","T0","B1","NL + (auto)"),
      node("nazorg", a, 290,30,"inforium_item","Content","Nazorg + alarmsignalen (taal)","Wanneer bellen, in taal patiënt.","T+1","B1","NL + (auto)"),
    ]
  );
}

/* --- VERRICHTING/OPERATIE: DIGITAAL SAVVY --- */
function templateVerrichtingDigitaal(){
  const a = "digitaal_savvy";
  return baseTemplate(
    "verr_digitaal",
    "Verrichting/operatie — Digitaal savvy (self-service)",
    "Portaal/app als ‘single source of truth’, intake digitaal, reminders, uitslagflow.",
    [
      node("vooraf", a, 24, 30,"portaal","Kanaal","Portaal: complete stappenlijst","Voorbereiding + videos + FAQs in 1 flow.","T-10","B1","NL"),
      node("vooraf", a, 290,30,"vragenlijst","Kanaal","Digitale pre-check","Antistolling/allergie/klachten/ vervoer.","T-7","B1","NL"),
      node("vooraf", a, 24, 170,"beterdichtbij","Kanaal","Chat bij vragen","Asynchroon vragen stellen.","T-7","B1","NL"),
      node("vooraf", a, 290,170,"reminder","Actie","Reminder nuchter + medicatie","T-1 met knoppen + deeplink naar checklist.","T-1","B1","NL"),
      node("dagzelf", a, 24, 30,"send_qr","Actie","QR check-in","QR voor aanmelding + route in app.","T0","B1","NL"),
      node("nazorg", a, 290,30,"inforium_item","Content","Nazorg + alarmsignalen","Kort + direct bellen-knop.","T+1","B1","NL"),
      node("followup", a, 24, 30,"send_link","Actie","Uitslag + vervolgafspraak","Uitslag in portaal + afspraakplanner.","T+7","B1","NL"),
      node("followup", a, 290,30,"feedback","Actie","Feedback","Korte survey + begrip.","T+3","B1","NL"),
    ]
  );
}
</script>
</body>
</html>
